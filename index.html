<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–¢–∞–±–ª–æ –∞–≤—Ç–æ–±—É—Å–æ–≤ ‚Äî Gie√üen</title>
  <style>
    body {
      margin: 0;
      background: #000;
      color: #00ff9c;
      font-family: monospace;
      padding: 16px;
    }
    h1 {
      margin: 0 0 12px;
      text-align: center;
      font-size: 22px;
    }
    .row {
      display: grid;
      grid-template-columns: 70px 1fr 90px;
      gap: 8px;
      padding: 10px 0;
      border-bottom: 1px solid #033;
      font-size: 20px;
    }
    .time {
      text-align: right;
      font-weight: bold;
    }
    .status {
      text-align: center;
      opacity: 0.7;
      margin-top: 10px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>üöå Gie√üen ‚Äî –û—Å—Ç–∞–Ω–æ–≤–∫–∞ ‚ÄúMarktplatz‚Äù</h1>
  <div id="board">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–±–ª–æ‚Ä¶</div>
  <div class="status" id="status">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥</div>

  <script>
    // üîë –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–ô accessId –æ—Ç RMV
    const API_KEY = "1775f9f1-32b8-48ad-98c8-06b2f6276fa0";

    // üß± –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π CORS-–ø—Ä–æ–∫—Å–∏, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–æ –ª–æ–∫–∞–ª—å–Ω–æ (file://)
    const PROXY = "https://cors.isomorphic-git.org/";

    // üìç ID —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (Gie√üen Marktplatz)
    const STOP_ID = "3019188"; // –µ—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî —Å–∫–∞–∂–∏, –ø–æ–¥–±–µ—Ä—É –¥—Ä—É–≥–æ–π ID

    const board = document.getElementById("board");
    const status = document.getElementById("status");

    function minutesFromNow(timeStr) {
      if (!timeStr) return "‚Äî";
      const [h, m] = timeStr.split(":").map(Number);
      const now = new Date();
      const t = new Date(now);
      t.setHours(h, m, 0, 0);
      let min = Math.round((t - now) / 60000);
      if (min < 0) min += 24 * 60;
      return min > 0 ? min + " –º–∏–Ω" : "—Å–µ–π—á–∞—Å";
    }

    async function loadBoard() {
      try {
        status.textContent = "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ‚Ä¶";
        const url = PROXY + `https://www.rmv.de/hapi/departureBoard?accessId=${API_KEY}&id=${STOP_ID}&format=json&maxJourneys=8`;
        const res = await fetch(url);
        const data = await res.json();
        const list = data.Departure || [];

        if (!list.length) {
          board.textContent = "–ù–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–π –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è";
          status.textContent = "–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: " + new Date().toLocaleTimeString();
          return;
        }

        board.innerHTML = list.map(d => `
          <div class="row">
            <div>üöå ${d.line}</div>
            <div>${d.direction || ""}</div>
            <div class="time">${minutesFromNow(d.rtTime || d.time)}</div>
          </div>
        `).join("");

        status.textContent = "–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: " + new Date().toLocaleTimeString();
      } catch (e) {
        console.error(e);
        board.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–æ";
        status.textContent = "–ü—Ä–æ–≤–µ—Ä—å API-–∫–ª—é—á –∏–ª–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç";
      }
    }

    loadBoard();
    setInterval(loadBoard, 30000);
  </script>
</body>
</html>